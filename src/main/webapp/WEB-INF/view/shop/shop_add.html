<!DOCTYPE html>
<html>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta name="renderer" content="webkit">
<head>
<meta charset="UTF-8">
<title>商家管理</title> <#include '/common/resources.html'>
<link rel="stylesheet" media="screen and (min-width: 1580px)" href="${base}/resources/css/sys/kd.css" />
<link rel="stylesheet" media="screen and (max-width: 1580px)" href="${base}/resources/css/sys/kd-resolving.css" />
<link rel="stylesheet" type="text/css" href="${base}/resources/datetimepicker/jquery.datetimepicker.css"/>
<link rel="stylesheet" type="text/css" href="${base }/resources/uploadify/uploadify.css">
<script src="${base}/resources/js/respond.js" type="text/javascript" async="async"></script>
<script src="${base}/resources/uploadify/jquery.uploadify.min.js" type="text/javascript"></script>
<script type="text/javascript" src="${base}/resources/js/linle_common.js"></script>
<style>
.ads-choice input {
	float: left;
	margin-top: 10px;
}

.ads-choice span {
	float: left;
	margin-top: 8px;
	margin-left: 5px;
}

.ads-choice label {
	float: left;
	margin-left: 10px;
}

.adstime {
	margin-left: 20px;
	width: 80%;
	height: 35px;
	border-radius: 3px;
	float: left;
	position: relative;
	margin-bottom: 20px;
}

.adstime span {
	float: left;
}

.adstime input {
	float: left;
	width: 150px;
}

.miaosu {
	width: 300px;
	height: 150px;
	padding: 10px;
}

.kdleft2 {
	width: 98%;
	float: left;
	margin: 15px 1%;
	min-height: 100%;
	background-color: white;
	overflow: auto;
	height: auto;
	position: absolute;
}
.allxq{
	float: left;width: auto;max-width:800px;		
}
.onexq{
	width:100%;float: left;max-width: 600px;border-bottom: 1px solid gainsboro;padding-bottom: 10px;padding-top: 5px;
}
.onexq-name{min-width: 70px;float: left;}
.nextxq-name{
	float: left;max-width: 500px;width: auto;
}
.single-name,.single-name input,.single-name span{
	float: left;
}
.single-name input,.single-name span{
	float: left;margin-bottom: 5px;
}
.allxq .float{
	float: left;
}
.allxq .margin{
width:100%;
	margin-top: 5px;
	padding-bottom: 10px;
}
</style>

</head>

<body>
	<div class="kdwhole">
		<ol class="breadcrumb">
			<li><a href="javascript:void(0)">商家</a></li>
			<li class="active">商家信息维护</li>
		</ol>

		<div class="kdleft2">
			<div class="head">
				<span class="mes-wh">商家信息维护</span>
			</div>
			<form action="${base}/sys/shop/add" method="post" id="shopform">
			<div class="Sheet">
				<div class="s-title">
					<span class="choice">商家名称：</span>
					<div class="inp" style="width: 300px;">
						<input maxlength="20" type="text"
							onkeyup="javascript:setShowLength(this, 20, 'cost_tpl_title_length');" name="shopName" id="shopName" value="${shop.shopName!!}"
							<#if shop.shopName??>
								disabled="disabled"
							</#if>
							/>
						<span class="cue" id="cost_tpl_title_length">0/20</span>
					</div>
				</div>

				<div class="s-name">
					<span class="choice">商家logo：</span>
		 			<div id="url" style="text-align:left;float: left;margin-left: 17px;">
                        <input type="file" name="file" id="file_upload" >
                        <input type="hidden" name="shopLogo" id="logo" value="${shop.shopLogo!!}"/>
                   </div>
				</div>

				<div class="s-address">
					<span class="choice">商家地址：</span>

					<div class="ads" style="width: 300px;">
						<input type="text" placeholder="请输入详细地址" name="shopAddress" id="shopAddress" value="${shop.shopAddress!!}"/>
					</div>
				</div>

				<div class="s-address">
					<span class="choice">配送公司：</span>
					<div class="ads" style="width: 300px;">
						<input type="text" placeholder="请输入配送公司名称" name="deliveryName" value="${shop.deliveryName!!}"/>
					</div>
				</div>
				
				<div class="s-address">
					<span class="choice">起送价&nbsp;：</span>
					<div class="ads" style="width: 300px;">
						<input type="text" placeholder="请输入起送价" name="sendPrice" value="${shop.sendPrice!!}" id="sendPrice"/>
					</div>
				</div>
				
				<div class="s-address">
					<span class="choice">配送费&nbsp;：</span>

					<div class="ads" style="width: 300px;">
						<input type="text" placeholder="请输入配送费" name="deliveryFee" value="${shop.deliveryFee!!}" id="deliveryFee"/>
					</div>
				</div>
				<div class="s-address">
					<div>
						<span class="choice">是否营业：</span>
					</div>

					<div class="ads-choice">
						<label for="open"><input id="open" type="radio"name="operateStatus" value="0" checked="checked"/><span>营业</span></label>
						<label for="close"><input id="close" type="radio" name="operateStatus"value="1"/><span>歇业</span></label>
					</div>
				</div>
				<div class="s-address">
					<div>
						<span class="choice">商家状态：</span>
					</div>
					<div class="ads-choice">
						<label for="normal"><input id="normal" type="radio" name="shopStatus" value="0" checked="checked"/><span>正常</span></label>
						<label for="stata"><input id="stata" type="radio" name="shopStatus" value="1"/><span>禁用</span></label>
					</div>
				</div>
				<div class="s-address">
					<div>
						<span class="choice">参与活动：</span>
					</div>
					<div class="ads-choice">
						<label for="normal"><input id="normal" type="radio" name="activityFlag" value="0" checked="checked"/><span>否</span></label>
						<label for="stata"><input id="stata" type="radio" name="activityFlag" value="1"/><span>是</span></label>
					</div>
				</div>
				<div class="s-address">
					<div style="float: left; width: 83px;">
						<span class="choice">配送小区：</span>
					</div>

<!-- 					<div class="ads-choice" style="float: left; width: 70%;"> -->
<!-- 						<#if community?exists && community?size gt 0> -->
<!-- 							<#list community as community> -->
<!-- 								<label for="open${community_index+1}"><input id="open${community_index+1}" type="checkbox" value="${community.id}" name="enterCommunity" -->
<!-- 								<#if cUser.identity=="SJ"> -->
<!-- 									disabled="disabled" -->
<!-- 								</#if> -->
<!-- 								/><span>${community.name}</span></label> -->
<!-- 							</#list> -->
<!-- 						</#if> -->
<!-- 					</div> -->

						<#if communityVo?exists && communityVo?size gt 0>
							<div class="allxq">
							<#if cUser.identity!="SJ">
								<div class="float margin">
									<label>
										<span class="float" style="font-weight: bold;">全选</span>
										<input class="float" name="allBigCheckBox" type="checkbox"/>
									</label>
								</div>
							</#if>
							<#list communityVo as communityVo>
								<div class="onexq" >
									<div class="onexq-name"><span style="float: left;font-weight: bold;">${communityVo.regionAddress}：</span></div>
										<div class="nextxq-name">
									<#if cUser.identity!="SJ">
											<div class="single-name">
												<label><input type="checkbox" name="allCheckBox"  /> <span style="font-weight: bold;">全选</span></label>
											</div>
									</#if>	
									<#list communityVo.communityList as community>
											<div class="single-name">
													<label><input id="open${community_index+1}" type="checkbox" value="${community.id}" name="enterCommunity" 	
													<#if cUser.identity=="SJ">
														disabled="disabled"
													</#if>/>
													<span>${community.name}</span></label>
											</div>
									</#list>
										</div>	
								</div>
							</#list>
							</div>
							</#if>
							
				</div>
				<div class="s-name">
					<span class="choice" style="width: 80px;">分&nbsp;&nbsp;类：</span>
					<div class="province">
						<select  id="mainType" name="mainType.id">
							<option value="">请选择</option>
							<#list mainList as main>
								<option value="${main.id}">${main.typeName}</option>
							</#list>
						</select>
					</div>
					<div class="province" id="child"
					<#if childList?exists && childList?size gt 0>
					>
						<#else>
						style="display: none;">
					</#if>
						<select  id="childType" name="childType.id">
							<#if childList?exists && childList?size gt 0>
								<#list childList as child>
									<option value="${child.id}">${child.typeName}</option>
								</#list>
							</#if>
						</select>
					</div>
				</div>
				<div class="s-address">
					<div style="float: left; width: 80px;">
						<span class="choice">营业时间：</span>
					</div>
					<div style="float: left; width: 70%;">
						<div class="adstime" style="height: auto;">
							<span>开始时间：</span><input id="star" type="text" name="operateBegin"
								class="time_element"  value="${shop.operateBegin!!}" readonly="readonly"/>
						</div>
						<div class="adstime" style="height: auto;">
							<span>结束时间：</span><input id="end" type="text" name="operateEnd"
								class="time_element" value="${shop.operateEnd!!}" readonly="readonly"/>
						</div>
					</div>
				</div>
				<div class="s-name">
					<span class="choice">商家证照：</span>
				<div id="credentials" style="text-align:left;float: left;margin-left: 17px;">
                        <input type="file" name="file2" id="file_upload2">
                        <input type="hidden" name="shopCredentials" id="shopCredentials"/>
                   </div>

				</div>
				<div class="s-name">
					<span class="choice">商家描述：</span>
					<div class="province">
						<textarea class="miaosu" name="introduction" id="introduction">${shop.introduction!!}</textarea>
					</div>
				
				<div class="s-address">
					<span class="choice">公告信息：</span>

					<div class="ads" style="width: 300px;">
						<input type="text" placeholder="请输入公告信息" name="notice" id="notice" value="${shop.notice!!}"/>
					</div>
				</div>
				
				<div class="s-address">
					<span class="choice">允许退款时间：</span>
					<div class="ads" style="width: 300px;">
						<input type="text" name="refundTime" id="refundTime" placeholder="用户下单后，多少小时内允许退款" value="${shop.refundTime!'24'}"/>
					</div>
				</div>
				
				</div>
				<div class="s-address">
					<span class="choice">联系电话：</span>
					<div class="phone">
						<input style="margin-top: 5px; padding: 5px; width: 200px;"type="text" name="shopPhone" value="${shop.shopPhone!!}" id="shopPhone"/>
					</div>
					<input type="hidden" id="folderID" value="${shop.shopCredentials!!}"/>
					<input type="hidden" name="id" id="id" value="${shop.id!!}">
					<button class="s-btn" style="cursor: pointer;">确认</button>
				</div>
			</div>
			</form>
		</div>

	</div>
	<script type="text/javascript">
    $(function () {
        $('#file_upload').uploadify({
            'swf': '${base }/resources/uploadify/uploadify.swf', //指定上传控件的主体文件，默认‘uploader.swf’
            'uploader': '${base}/sys/file/uploadFile', //指定服务器端上传处理文件
            'auto': true, //手动上传
            'buttonImage': '${base }/resources/uploadify/uploadify-browse.png', //浏览按钮背景图片
            'multi': false, //单文件上传
            'fileTypeExts': '*.gif; *.jpg; *.png;', //允许上传的文件后缀
            'fileSizeLimit': '1MB', //上传文件的大小限制，单位为B, KB, MB, 或 GB
            'successTimeout': 30, //成功等待时间
            'queueSizeLimit': 1,
            'fileObjName': 'file',
            'onUploadStart': function (file) {  
                $("#file_upload").uploadify("settings", "formData", {'type': 'shop_logo'});  
            },
            'onUploadSuccess': function (file, data) {//每成功完成一次文件上传时触发一次
                data = eval("(" + data + ")");
                $(".uploadimg").remove();
                $('#url').append("<div id=" + data.value + " class='uploadimg'> <img width=50 height=50 src='${base}/" + data.value + "' /> " +
                        "<a href=javascript:delimg('" + data.value + "','')>删除</a> </div>");
                $("#logo").val(data.value);
            },
            'onUploadError': function (file, data) {//当上传返回错误时触发
                $('#url').append("<li>" + data + "</li>");

            }
        });
        
        $('#file_upload2').uploadify({
            'swf': '${base }/resources/uploadify/uploadify.swf', //指定上传控件的主体文件，默认‘uploader.swf’
            'uploader': '${base}/sys/file/uploadFiles', //指定服务器端上传处理文件
            'auto': true, //手动上传
            'buttonImage': '${base }/resources/uploadify/uploadify-browse.png', //浏览按钮背景图片
            'multi': true, //单文件上传
            'fileTypeExts': '*.gif; *.jpg; *.png;', //允许上传的文件后缀
            'fileSizeLimit': '1MB', //上传文件的大小限制，单位为B, KB, MB, 或 GB
            'successTimeout': 30, //成功等待时间
            'queueSizeLimit': 10,
            'fileObjName': 'file2',
            'onUploadStart': function (file) {  
                $("#file_upload2").uploadify("settings", "formData", { 'foldeID': $("#folderID").val(),'type': 'shop' });  
                //在onUploadStart事件中，也就是上传之前，把参数写好传递到后台。  
            },
            'onUploadSuccess': function (file, data) {//每成功完成一次文件上传时触发一次
                data = eval("(" + data + ")");
                $("#folderID").val(data.value[0].folderId);
                $('#credentials').append("<div id=" + data.value[0].path+ " class='uploadimgs'> <img width=50 height=50 src=${base}/" + data.value[0].path + " /> " +
                        "<a href=javascript:delimg('" + data.value[0].path + "','logo')>删除</a> </div>");
                $("#shopCredentials").val(data.value[0].folderId);
            },
            'onUploadError': function (file, data) {//当上传返回错误时触发
//                 $('#url').append("<li>" + data + "</li>");

            }
        });
        

    });
    <!--删除图片-->
    function delimg(obj, tval) {
        var url = "${base}/sys/file/delimg";
        $.post(url, {'imgpath': obj}, function (data) {
            if (data.code == 0||data.code == 2) {
	                document.getElementById(obj).remove();
	                if(tval!=''){
	                	document.getElementById(tval).value = "";
	                }
	                layer.msg("删除图片成功");
	            }
        });
    }
    
    $("#mainType").change(function(){
    	var url = '${base}/shopChildType/selectBymain';
    	var mainType = $(this).val();
    	  $.post(url, {'mid': mainType}, function (data) {
    		  if(data.length>0){
    			  var html = "";
    			  for(var i = 0;i<data.length;i++){
    				  html+="<option value='"+data[i].id+"'>"+data[i].typeName+"</option>";
    			  }
    			  $("#childType").append(html);
    			  $("#child").show();
    		  }else{
    			  $("#childType").empty(); 
    			  $("#child").hide();
    		  }
          })
    })
    	    $("#shopform").submit(function() {
        	var type = $("#shopType").val();
        	if(type=='main'){
        		$("#typeId").val($("#mainType").val());
        	}else{
        		$("#typeId").val($("#childType").val());
        	}
        	if($("#shopName").val()==''){
        		layer.msg("店铺名称不能为空");
        		return false;
        	}
        	
        	if($("#shopLogo").val()==''){
        		layer.msg("商家logo不能为空");
        		return false;
        	}
        	
        	if($("#sendPrice").val()==""){
        		layer.msg("起送价不能为空");
        		return false;
        	}
        	if(isNaN($("#sendPrice").val()) || $("#sendPrice").val()<0){
        		layer.msg("起送价输入错误");
        		return false;
        	}
        	
        	if($("#deliveryFee").val()==""){
        		layer.msg("配送费不能为空");
        		return false;
        	}
        	
        	if(isNaN($("#deliveryFee").val()) || $("#deliveryFee").val()<0){
        		layer.msg("配送费输入错误");
        		return false;
        	}
        	
        	if($("#id").val()==""){
    			if(checkUserExsit($("#shopName").val(),'${base}')){
    				return false;
    			}
    		}
        	
        	if($("#shopAddress").val()==''){
        		layer.msg("商铺地址不能为空");
        		return false;
        	}
        	if($("#mainType").val()==''){
        		layer.msg("请选择商铺类型");
        		return false;
        	}
        	if($("#refundTime").val()==''){
        		layer.msg("退款时间不能为空");
        	}else{
        		var reg=/^[0-9]*[1-9][0-9]*$/;
        		if(!reg.test($("#refundTime").val())){
        			layer.msg("退款时间必须为正整数");
        			return false;
        		}
        	}
        	
        	if($("#shopPhone").val()==''){
        		layer.msg("店铺联系电话不能为空");
        		return false;
        	}
        	var shopPhone=$("#shopPhone").val();
        	if(!checkThreePhone(shopPhone)){
        		layer.msg("联系电话输入有误!");
        		return false;
        	}
    		var ajax_url = $(this).attr("action"); //表单目标 
    		var ajax_type = $(this).attr('method'); //提交方法 
    		var ajax_data = $(this).serialize(); //表单数据 
    		ajax_data.shopName=$("#shopName").val();
    		$.ajax({
    			type : ajax_type, //表单提交类型 
    			url : ajax_url, //表单提交目标 
    			data : ajax_data, //表单数据
    			success : function(data) {
    				 layer.msg(data.msg,{
    				     	shift: 0
    				     }, function(){
    				    	 <#if cUser.identity=="SJ">
    				    		 window.location.reload();
    				    		 <#else>
    				    	 	window.location.href="${base}/sys/shop/list";
    				    	 </#if>
    				     });
    			}
    		});
    		return false; //阻止表单的默认提交事件 
    	});
	</script>
<script src="${base}/resources/datetimepicker/jquery.datetimepicker.js" ></script>
	<script>
			$('.time_element').datetimepicker({
				datepicker: false,
				format: 'H:i',
				step: 30
			});
		
		function setShowLength(obj, maxlength, id) {
			var rem = maxlength - obj.value.length;
			var wid = id;
			if (rem < 0) {
				rem = 0;
			}
			document.getElementById(wid).innerHTML = rem + "/" + "20";
		}
		<#if (shop.id)??>
			$('#url').append("<div id='${shop.shopLogo}' class='uploadimg'> <img width=50 height=50 src='${base}/${shop.shopLogo}'/><a href=javascript:delimg('${shop.shopLogo}','')>删除</a> </div>");
			$("input[name='operateStatus'][value=${shop.operateStatus}]").attr("checked",true); 
			$("input[name='shopStatus'][value=${shop.shopStatus}]").attr("checked",true);
			$("input[name='activityFlag'][value=${shop.activityFlag!0}]").attr("checked",true);
			$('${shop.enterCommunity}'.split(",")).each(function(index,val){
				$("input[name='enterCommunity'][value="+val+"]").attr('checked','true');
			})
			
			$("#mainType").val('${shop.mainType.id}');
			<#if shop.childType??>
				$("#childType").val('${shop.childType.id}');
			</#if>
			<#if (shop.folder)??>
				$("#shopCredentials").val('${shop.folder.id}');
				var folder = ${shop.folder};
				$(folder.files).each(function(index,val){
					 $('#credentials').append("<div id=" +val.path+ " class='uploadimgs'> <img width=50 height=50 src=${base}/" + val.path + " /> " +
		            "<a href=javascript:delimg('" + val.path + "','')>删除</a> </div>");
				})
			</#if>
       </#if>
       //全选
	    $("[name=allBigCheckBox]").click(function(){
	   	   if(this.checked){
	   		   $("input[name='enterCommunity']").prop("checked",true); 
	   		 	$("input[name='allCheckBox']").prop("checked",true); 
	   		
	   	   }else{
	   		   $("input[name='enterCommunity']").prop("checked",false); 
	   			$("input[name='allCheckBox']").prop("checked",false); 
	   	   }
	     })
        //小区全选/反选
	    $("[name=allCheckBox]").click(function(){
    	   if(this.checked){
    		   $(this).parent().parent().parent().parent().find("input[name='enterCommunity']").prop("checked",true); 
    	   }else{
    		   $(this).parent().parent().parent().parent().find("input[name='enterCommunity']").prop("checked",false); 
    	   }
       })
	</script>
</body>

</html>